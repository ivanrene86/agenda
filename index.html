<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Citas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            font-weight: 600;
        }

        .controles {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filtro-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filtro-container label {
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        select {
            padding: 12px 20px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        select:hover {
            border-color: #764ba2;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        select:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-agendar {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-agendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-agendar:active {
            transform: translateY(0);
        }

        .contenido-citas {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 200px;
        }

        .contenido-citas.vacio {
            text-align: center;
            color: #666;
        }

        .contenido-citas.vacio p {
            font-size: 1.2em;
            margin-top: 20px;
        }

        .lista-citas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .tarjeta-cita {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .tarjeta-cita:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .tarjeta-cita.abierta {
            border-left-color: #28a745;
        }

        .tarjeta-cita.terminada {
            border-left-color: #6c757d;
        }

        .tarjeta-cita.anulada {
            border-left-color: #dc3545;
        }

        .cita-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .cita-mascota {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .cita-estado {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .estado-abierta {
            background: #d4edda;
            color: #155724;
        }

        .estado-terminada {
            background: #e2e3e5;
            color: #383d41;
        }

        .estado-anulada {
            background: #f8d7da;
            color: #721c24;
        }

        .cita-info {
            margin-bottom: 10px;
        }

        .cita-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        .cita-info-item strong {
            color: #333;
            min-width: 90px;
        }

        .cita-sintomas {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .cita-sintomas strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .cita-sintomas p {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0;
        }

        .cita-factura {
            margin-top: 12px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }

        .cita-factura-titulo {
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cita-factura-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .cita-factura-item strong {
            color: #333;
        }

        .cita-factura-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #0066cc;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.1em;
            color: #0066cc;
        }

        .cita-acciones {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-peque√±o {
            padding: 8px 15px;
            font-size: 0.85em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-editar {
            background: #007bff;
            color: white;
        }

        .btn-editar:hover {
            background: #0056b3;
        }

        .btn-terminar {
            background: #6c757d;
            color: white;
        }

        .btn-terminar:hover {
            background: #5a6268;
        }

        .btn-anular {
            background: #ffc107;
            color: #333;
        }

        .btn-anular:hover {
            background: #e0a800;
        }

        .btn-eliminar {
            background: #dc3545;
            color: white;
        }

        .btn-eliminar:hover {
            background: #c82333;
        }

        .btn-ver-factura {
            background: #17a2b8;
            color: white;
        }

        .btn-ver-factura:hover {
            background: #138496;
        }

        .btn-imprimir {
            background: #28a745;
            color: white;
        }

        .btn-imprimir:hover {
            background: #218838;
        }

        /* Modal para agendar cita */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-contenido {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header.editar {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .modal-header.factura {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .btn-cerrar {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .btn-cerrar:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #28a745;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }

        .btn-secundario {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secundario:hover {
            background: #5a6268;
        }

        .btn-primario {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .btn-primario:active {
            transform: translateY(0);
        }

        .btn-primario.editar {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }

        .btn-primario.editar:hover {
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6);
        }

        .btn-primario.factura {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        }

        .btn-primario.factura:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.6);
        }

        /* Modal de confirmaci√≥n */
        .modal-confirmacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-confirmacion.active {
            display: flex;
        }

        .confirmacion-contenido {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .confirmacion-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .confirmacion-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .confirmacion-body {
            padding: 30px;
            text-align: center;
        }

        .confirmacion-body p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
        }

        .confirmacion-body .nombre-mascota {
            font-weight: 700;
            color: #dc3545;
            font-size: 1.2em;
        }

        .confirmacion-footer {
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid #eee;
        }

        .btn-cancelar-eliminar {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancelar-eliminar:hover {
            background: #5a6268;
        }

        .btn-confirmar-eliminar {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirmar-eliminar:hover {
            background: #c82333;
        }

        /* Estilos para impresi√≥n de factura */
        .factura-impresion {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .factura-impresion,
            .factura-impresion * {
                visibility: visible;
            }
            
            .factura-impresion {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block;
                padding: 20px;
            }

            .no-imprimir {
                display: none !important;
            }
        }

        .factura-documento {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border: 2px solid #333;
        }

        .factura-encabezado {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #333;
            padding-bottom: 20px;
        }

        .factura-encabezado h1 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .factura-numero {
            font-size: 1.2em;
            color: #666;
            font-weight: 600;
        }

        .factura-detalles {
            margin-bottom: 30px;
        }

        .factura-seccion {
            margin-bottom: 20px;
        }

        .factura-seccion h3 {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .factura-fila {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .factura-fila strong {
            color: #333;
        }

        .factura-total-final {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid #667eea;
            text-align: right;
        }

        .factura-total-final .monto {
            font-size: 2em;
            color: #667eea;
            font-weight: 700;
        }

        .factura-pie {
            margin-top: 50px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
            border-top: 2px solid #333;
            padding-top: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .controles {
                flex-direction: column;
                align-items: stretch;
            }

            .filtro-container {
                flex-direction: column;
                align-items: stretch;
            }

            select, .btn-agendar {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-contenido {
                width: 95%;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                flex-direction: column;
            }

            .btn-secundario,
            .btn-primario {
                width: 100%;
            }

            .confirmacion-footer {
                flex-direction: column;
            }

            .btn-cancelar-eliminar,
            .btn-confirmar-eliminar {
                width: 100%;
            }

            .lista-citas {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Administrador de Citas</h1>
        
        <div class="controles">
            <div class="filtro-container">
                <label for="filtro-estado">Filtrar por estado:</label>
                <select id="filtro-estado">
                    <option value="todas">Todas las citas</option>
                    <option value="abierta">Abierta</option>
                    <option value="terminada">Terminada</option>
                    <option value="anulada">Anulada</option>
                </select>
            </div>
            
            <button class="btn-agendar" id="btn-agendar">+ Agendar Cita</button>
        </div>

        <div class="contenido-citas" id="contenido-citas">
            <p>üìÖ Aqu√≠ se mostrar√°n las citas filtradas</p>
        </div>
    </div>

    <!-- Modal para agendar/editar cita -->
    <div class="modal" id="modal-cita">
        <div class="modal-contenido">
            <div class="modal-header" id="modal-header">
                <h2 id="modal-titulo">Guardar nueva cita</h2>
                <button class="btn-cerrar" id="btn-cerrar-modal">‚úï</button>
            </div>
            
            <form id="form-cita">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="nombre-mascota">Nombre Mascota *</label>
                        <input type="text" id="nombre-mascota" placeholder="Nombre de la mascota">
                    </div>

                    <div class="form-group">
                        <label for="propietario">Propietario *</label>
                        <input type="text" id="propietario" placeholder="Nombre del propietario">
                    </div>

                    <div class="form-group">
                        <label for="telefono">Tel√©fono *</label>
                        <input type="tel" id="telefono" placeholder="0">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha-cita">Fecha de cita *</label>
                            <input type="date" id="fecha-cita">
                        </div>

                        <div class="form-group">
                            <label for="hora-cita">Hora de cita * (8:00 AM - 8:00 PM)</label>
                            <input type="time" id="hora-cita">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tipo-mascota">Tipo de mascota *</label>
                        <select id="tipo-mascota">
                            <option value="">No aplica</option>
                            <option value="perro">Perro</option>
                            <option value="gato">Gato</option>
                            <option value="ave">Ave</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sintomas">S√≠ntomas *</label>
                        <textarea id="sintomas" placeholder="Describe los s√≠ntomas..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secundario" id="btn-cancelar">CERRAR</button>
                    <button type="submit" class="btn-primario" id="btn-guardar">GUARDAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para facturaci√≥n -->
    <div class="modal" id="modal-factura">
        <div class="modal-contenido">
            <div class="modal-header factura">
                <h2>üí∞ Facturar Cita</h2>
                <button class="btn-cerrar" id="btn-cerrar-modal-factura">‚úï</button>
            </div>
            
            <form id="form-factura">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="servicio-prestado">Servicio Prestado *</label>
                        <input type="text" id="servicio-prestado" placeholder="Ej: Consulta general, Vacunaci√≥n, Cirug√≠a...">
                    </div>

                    <div class="form-group">
                        <label for="precio-servicio">Precio del Servicio *</label>
                        <input type="number" id="precio-servicio" placeholder="0.00" step="0.01" min="0">
                    </div>

                    <div class="form-group">
                        <label for="metodo-pago">M√©todo de Pago *</label>
                        <select id="metodo-pago">
                            <option value="">Seleccionar...</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fecha-pago">Fecha de Pago *</label>
                        <input type="date" id="fecha-pago">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secundario" id="btn-cancelar-factura">CERRAR</button>
                    <button type="submit" class="btn-primario factura">GUARDAR FACTURA</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver factura -->
    <div class="modal" id="modal-ver-factura">
        <div class="modal-contenido" style="max-width: 800px;">
            <div class="modal-header factura">
                <h2>üìÑ Factura</h2>
                <button class="btn-cerrar" id="btn-cerrar-ver-factura">‚úï</button>
            </div>
            
            <div class="modal-body" id="contenido-factura-visualizar">
                <!-- Aqu√≠ se mostrar√° la factura -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secundario" id="btn-cerrar-factura-ver">CERRAR</button>
                <button type="button" class="btn-primario factura" id="btn-imprimir-factura">üñ®Ô∏è IMPRIMIR</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div class="modal-confirmacion" id="modal-confirmacion">
        <div class="confirmacion-contenido">
            <div class="confirmacion-header">
                <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
            </div>
            
            <div class="confirmacion-body">
                <p>¬øEst√°s seguro de que deseas eliminar la cita de:</p>
                <p class="nombre-mascota" id="nombre-mascota-eliminar"></p>
                <p style="color: #666; font-size: 0.95em; margin-top: 10px;">Esta acci√≥n no se puede deshacer.</p>
            </div>

            <div class="confirmacion-footer">
                <button class="btn-cancelar-eliminar" id="btn-cancelar-eliminar">Cancelar</button>
                <button class="btn-confirmar-eliminar" id="btn-confirmar-eliminar">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor oculto para impresi√≥n -->
    <div class="factura-impresion" id="factura-impresion"></div>

    <script>
        // Seleccionamos los elementos del DOM
        const filtroEstado = document.getElementById('filtro-estado');
        const btnAgendar = document.getElementById('btn-agendar');
        const contenidoCitas = document.getElementById('contenido-citas');
        const modal = document.getElementById('modal-cita');
        const modalHeader = document.getElementById('modal-header');
        const modalTitulo = document.getElementById('modal-titulo');
        const btnCerrarModal = document.getElementById('btn-cerrar-modal');
        const btnCancelar = document.getElementById('btn-cancelar');
        const btnGuardar = document.getElementById('btn-guardar');
        const formCita = document.getElementById('form-cita');

        // Elementos del formulario
        const nombreMascota = document.getElementById('nombre-mascota');
        const propietario = document.getElementById('propietario');
        const telefono = document.getElementById('telefono');
        const fechaCita = document.getElementById('fecha-cita');
        const horaCita = document.getElementById('hora-cita');
        const tipoMascota = document.getElementById('tipo-mascota');
        const sintomas = document.getElementById('sintomas');

        // Modal de facturaci√≥n
        const modalFactura = document.getElementById('modal-factura');
        const btnCerrarModalFactura = document.getElementById('btn-cerrar-modal-factura');
        const btnCancelarFactura = document.getElementById('btn-cancelar-factura');
        const formFactura = document.getElementById('form-factura');
        const servicioPrestado = document.getElementById('servicio-prestado');
        const precioServicio = document.getElementById('precio-servicio');
        const metodoPago = document.getElementById('metodo-pago');
        const fechaPago = document.getElementById('fecha-pago');

        // Modal para ver factura
        const modalVerFactura = document.getElementById('modal-ver-factura');
        const btnCerrarVerFactura = document.getElementById('btn-cerrar-ver-factura');
        const btnCerrarFacturaVer = document.getElementById('btn-cerrar-factura-ver');
        const btnImprimirFactura = document.getElementById('btn-imprimir-factura');
        const contenidoFacturaVisualizar = document.getElementById('contenido-factura-visualizar');

        // Modal de confirmaci√≥n
        const modalConfirmacion = document.getElementById('modal-confirmacion');
        const nombreMascotaEliminar = document.getElementById('nombre-mascota-eliminar');
        const btnCancelarEliminar = document.getElementById('btn-cancelar-eliminar');
        const btnConfirmarEliminar = document.getElementById('btn-confirmar-eliminar');

        // Variables de control
        let editando = false;
        let idCitaEditando = null;
        let idCitaEliminar = null;
        let idCitaFacturando = null;
        let idCitaViendoFactura = null;

        // Array para almacenar las citas
        let citas = [];

        // Funci√≥n para cargar las citas desde localStorage
        function cargarCitas() {
            const citasGuardadas = localStorage.getItem('citas');
            if (citasGuardadas) {
                citas = JSON.parse(citasGuardadas);
                console.log('‚úÖ Citas cargadas desde localStorage:', citas.length);
            } else {
                citas = [];
                console.log('üìù No hay citas guardadas previamente');
            }
        }

        // Funci√≥n para guardar las citas en localStorage
        function guardarCitas() {
            localStorage.setItem('citas', JSON.stringify(citas));
            console.log('üíæ Citas guardadas en localStorage');
        }

        // Cargar las citas al iniciar
        cargarCitas();

        // Establecer la fecha m√≠nima en el campo de fecha (desde ma√±ana en adelante)
        const ma√±ana = new Date();
        ma√±ana.setDate(ma√±ana.getDate() + 1);
        const a√±oM = ma√±ana.getFullYear();
        const mesM = String(ma√±ana.getMonth() + 1).padStart(2, '0');
        const diaM = String(ma√±ana.getDate()).padStart(2, '0');
        fechaCita.min = `${a√±oM}-${mesM}-${diaM}`;

        // Establecer la fecha actual en el campo de fecha de pago
        const hoy = new Date();
        const a√±oH = hoy.getFullYear();
        const mesH = String(hoy.getMonth() + 1).padStart(2, '0');
        const diaH = String(hoy.getDate()).padStart(2, '0');
        fechaPago.value = `${a√±oH}-${mesH}-${diaH}`;

        // Funci√≥n para formatear la fecha
        function formatearFecha(fecha) {
            const [a√±o, mes, dia] = fecha.split('-');
            return `${dia}/${mes}/${a√±o}`;
        }

        // Funci√≥n para formatear la hora de 24h a 12h con AM/PM
        function formatearHora(hora) {
            const [horas, minutos] = hora.split(':');
            let h = parseInt(horas);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${minutos} ${ampm}`;
        }

        // Funci√≥n para formatear el precio
        function formatearPrecio(precio) {
            return parseFloat(precio).toFixed(2);
        }

        // Funci√≥n para obtener el emoji seg√∫n el tipo de mascota
        function obtenerEmojiMascota(tipo) {
            const emojis = {
                'perro': 'üêï',
                'gato': 'üêà',
                'ave': 'ü¶ú',
                'otro': 'üêæ'
            };
            return emojis[tipo] || 'üêæ';
        }

        // Funci√≥n para generar n√∫mero de factura
        function generarNumeroFactura(id) {
            return `FACT-${String(id).padStart(6, '0')}`;
        }

        // Funci√≥n para renderizar las citas
        function renderizarCitas(filtro = 'todas') {
            // Si no hay citas en total
            if (citas.length === 0) {
                contenidoCitas.className = 'contenido-citas vacio';
                contenidoCitas.innerHTML = '<p>üìÖ No hay citas registradas. ¬°Agenda la primera!</p>';
                return;
            }

            // Filtrar citas seg√∫n el estado seleccionado
            let citasFiltradas;
            if (filtro === 'todas') {
                citasFiltradas = citas;
            } else {
                citasFiltradas = citas.filter(cita => cita.estado === filtro);
            }

            // Si no hay citas con el filtro seleccionado
            if (citasFiltradas.length === 0 && filtro !== 'todas') {
                contenidoCitas.className = 'contenido-citas vacio';
                contenidoCitas.innerHTML = `<p>üìÖ No hay citas con estado: <strong>${filtro}</strong></p>`;
                return;
            }

            // Construir el HTML de las citas
            contenidoCitas.className = 'contenido-citas';
            let html = '<div class="lista-citas">';
            
            citasFiltradas.forEach((cita) => {
                const emojiMascota = obtenerEmojiMascota(cita.tipoMascota);
                html += `
                    <div class="tarjeta-cita ${cita.estado}">
                        <div class="cita-header">
                            <h3 class="cita-mascota">${emojiMascota} ${cita.nombreMascota}</h3>
                            <span class="cita-estado estado-${cita.estado}">${cita.estado}</span>
                        </div>
                        
                        <div class="cita-info">
                            <div class="cita-info-item">
                                <strong>üë§ Propietario:</strong>
                                <span>${cita.propietario}</span>
                            </div>
                            <div class="cita-info-item">
                                <strong>üìû Tel√©fono:</strong>
                                <span>${cita.telefono}</span>
                            </div>
                            <div class="cita-info-item">
                                <strong>üìÖ Fecha:</strong>
                                <span>${formatearFecha(cita.fechaCita)}</span>
                            </div>
                            <div class="cita-info-item">
                                <strong>üïê Hora:</strong>
                                <span>${formatearHora(cita.horaCita)}</span>
                            </div>
                            <div class="cita-info-item">
                                <strong>üêï Tipo:</strong>
                                <span>${cita.tipoMascota.charAt(0).toUpperCase() + cita.tipoMascota.slice(1)}</span>
                            </div>
                        </div>
                        
                        <div class="cita-sintomas">
                            <strong>üíä S√≠ntomas:</strong>
                            <p>${cita.sintomas}</p>
                        </div>
                        
                        ${cita.factura ? `
                            <div class="cita-factura">
                                <div class="cita-factura-titulo">üí∞ Informaci√≥n de Factura</div>
                                <div class="cita-factura-item">
                                    <span>Servicio:</span>
                                    <strong>${cita.factura.servicio}</strong>
                                </div>
                                <div class="cita-factura-item">
                                    <span>M√©todo de pago:</span>
                                    <strong>${cita.factura.metodoPago.charAt(0).toUpperCase() + cita.factura.metodoPago.slice(1)}</strong>
                                </div>
                                <div class="cita-factura-item">
                                    <span>Fecha de pago:</span>
                                    <strong>${formatearFecha(cita.factura.fechaPago)}</strong>
                                </div>
                                <div class="cita-factura-total">
                                    <span>TOTAL:</span>
                                    <span>$${formatearPrecio(cita.factura.precio)}</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="cita-acciones">
                            ${cita.estado === 'abierta' ? `
                                <button class="btn-peque√±o btn-editar" onclick="editarCita(${cita.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn-peque√±o btn-terminar" onclick="abrirModalFactura(${cita.id})">
                                    ‚úì Terminar
                                </button>
                                <button class="btn-peque√±o btn-anular" onclick="cambiarEstado(${cita.id}, 'anulada')">
                                    ‚äò Anular
                                </button>
                            ` : ''}
                            ${cita.factura ? `
                                <button class="btn-peque√±o btn-ver-factura" onclick="verFactura(${cita.id})">
                                    üìÑ Ver Factura
                                </button>
                                <button class="btn-peque√±o btn-imprimir" onclick="imprimirFacturaDirecta(${cita.id})">
                                    üñ®Ô∏è Imprimir
                                </button>
                            ` : ''}
                            <button class="btn-peque√±o btn-eliminar" onclick="confirmarEliminar(${cita.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contenidoCitas.innerHTML = html;
        }

        // Funci√≥n para abrir el modal de facturaci√≥n
        window.abrirModalFactura = function(id) {
            idCitaFacturando = id;
            const cita = citas.find(c => c.id === id);
            
            if (cita) {
                // Resetear el formulario
                formFactura.reset();
                fechaPago.value = `${a√±oH}-${mesH}-${diaH}`;
                
                // Abrir el modal
                modalFactura.classList.add('active');
            }
        };

        // Funci√≥n para generar HTML de factura
        function generarHTMLFactura(cita) {
            const numeroFactura = generarNumeroFactura(cita.id);
            const emojiMascota = obtenerEmojiMascota(cita.tipoMascota);
            
            return `
                <div class="factura-documento">
                    <div class="factura-encabezado">
                        <h1>FACTURA</h1>
                        <p class="factura-numero">${numeroFactura}</p>
                    </div>

                    <div class="factura-detalles">
                        <div class="factura-seccion">
                            <h3>Datos del Cliente</h3>
                            <div class="factura-fila">
                                <strong>Nombre:</strong>
                                <span>${cita.propietario}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>Tel√©fono:</strong>
                                <span>${cita.telefono}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>Mascota:</strong>
                                <span>${emojiMascota} ${cita.nombreMascota} (${cita.tipoMascota.charAt(0).toUpperCase() + cita.tipoMascota.slice(1)})</span>
                            </div>
                        </div>

                        <div class="factura-seccion">
                            <h3>Datos de la Cita</h3>
                            <div class="factura-fila">
                                <strong>Fecha de cita:</strong>
                                <span>${formatearFecha(cita.fechaCita)}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>Hora:</strong>
                                <span>${formatearHora(cita.horaCita)}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>S√≠ntomas:</strong>
                                <span>${cita.sintomas}</span>
                            </div>
                        </div>

                        <div class="factura-seccion">
                            <h3>Servicio Prestado</h3>
                            <div class="factura-fila">
                                <strong>Servicio:</strong>
                                <span>${cita.factura.servicio}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>Precio:</strong>
                                <span>$${formatearPrecio(cita.factura.precio)}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>M√©todo de pago:</strong>
                                <span>${cita.factura.metodoPago.charAt(0).toUpperCase() + cita.factura.metodoPago.slice(1)}</span>
                            </div>
                            <div class="factura-fila">
                                <strong>Fecha de pago:</strong>
                                <span>${formatearFecha(cita.factura.fechaPago)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="factura-total-final">
                        <div>
                            <div>TOTAL A PAGAR:</div>
                            <div class="monto">$${formatearPrecio(cita.factura.precio)}</div>
                        </div>
                    </div>

                    <div class="factura-pie">
                        <p>Gracias por su preferencia</p>
                        <p>Factura generada el ${formatearFecha(`${a√±oH}-${mesH}-${diaH}`)}</p>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para ver factura
        window.verFactura = function(id) {
            const cita = citas.find(c => c.id === id);
            
            if (cita && cita.factura) {
                idCitaViendoFactura = id;
                contenidoFacturaVisualizar.innerHTML = generarHTMLFactura(cita);
                modalVerFactura.classList.add('active');
            }
        };

        // Funci√≥n para imprimir factura desde el modal de visualizaci√≥n
        btnImprimirFactura.addEventListener('click', function() {
            if (idCitaViendoFactura) {
                imprimirFacturaDirecta(idCitaViendoFactura);
            }
        });

        // Funci√≥n para imprimir factura directamente
        window.imprimirFacturaDirecta = function(id) {
            const cita = citas.find(c => c.id === id);
            
            if (cita && cita.factura) {
                const facturaImpresion = document.getElementById('factura-impresion');
                facturaImpresion.innerHTML = generarHTMLFactura(cita);
                window.print();
            }
        };

        // Event listeners para cerrar modal de factura
        btnCerrarModalFactura.addEventListener('click', function() {
            modalFactura.classList.remove('active');
            idCitaFacturando = null;
        });

        btnCancelarFactura.addEventListener('click', function() {
            modalFactura.classList.remove('active');
            idCitaFacturando = null;
        });

        modalFactura.addEventListener('click', function(e) {
            if (e.target === modalFactura) {
                modalFactura.classList.remove('active');
                idCitaFacturando = null;
            }
        });

        // Event listeners para cerrar modal de ver factura
        btnCerrarVerFactura.addEventListener('click', function() {
            modalVerFactura.classList.remove('active');
            idCitaViendoFactura = null;
        });

        btnCerrarFacturaVer.addEventListener('click', function() {
            modalVerFactura.classList.remove('active');
            idCitaViendoFactura = null;
        });

        modalVerFactura.addEventListener('click', function(e) {
            if (e.target === modalVerFactura) {
                modalVerFactura.classList.remove('active');
                idCitaViendoFactura = null;
            }
        });

        // Validar y guardar factura
        formFactura.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validaciones
            if (servicioPrestado.value.trim() === '') {
                alert('‚ö†Ô∏è Debes rellenar el campo "Servicio Prestado"');
                servicioPrestado.focus();
                return;
            }

            if (precioServicio.value === '' || parseFloat(precioServicio.value) <= 0) {
                alert('‚ö†Ô∏è Debes ingresar un precio v√°lido mayor a 0');
                precioServicio.focus();
                return;
            }

            if (metodoPago.value === '') {
                alert('‚ö†Ô∏è Debes seleccionar un m√©todo de pago');
                metodoPago.focus();
                return;
            }

            if (fechaPago.value === '') {
                alert('‚ö†Ô∏è Debes seleccionar una fecha de pago');
                fechaPago.focus();
                return;
            }

            // Buscar la cita
            const cita = citas.find(c => c.id === idCitaFacturando);
            
            if (cita) {
                // Guardar la factura en la cita
                cita.factura = {
                    servicio: servicioPrestado.value.trim(),
                    precio: precioServicio.value,
                    metodoPago: metodoPago.value,
                    fechaPago: fechaPago.value
                };

                // Cambiar el estado a terminada
                cita.estado = 'terminada';

                // Guardar en localStorage
                guardarCitas();

                // Cerrar modal
                modalFactura.classList.remove('active');
                idCitaFacturando = null;

                // Mostrar mensaje
                alert('‚úÖ Cita terminada y factura guardada exitosamente');

                // Renderizar de nuevo
                renderizarCitas(filtroEstado.value);
            }
        });

        // Funci√≥n para editar una cita
        window.editarCita = function(id) {
            const cita = citas.find(c => c.id === id);
            if (cita && cita.estado === 'abierta') {
                editando = true;
                idCitaEditando = id;

                // Cambiar el t√≠tulo y estilo del modal
                modalTitulo.textContent = 'Editar cita';
                modalHeader.classList.add('editar');
                btnGuardar.textContent = 'ACTUALIZAR';
                btnGuardar.classList.add('editar');

                // Cargar los datos de la cita en el formulario
                nombreMascota.value = cita.nombreMascota;
                propietario.value = cita.propietario;
                telefono.value = cita.telefono;
                fechaCita.value = cita.fechaCita;
                horaCita.value = cita.horaCita;
                tipoMascota.value = cita.tipoMascota;
                sintomas.value = cita.sintomas;

                // Abrir el modal
                modal.classList.add('active');
            }
        };

        // Funci√≥n para cambiar el estado de una cita
        window.cambiarEstado = function(id, nuevoEstado) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                cita.estado = nuevoEstado;
                guardarCitas();
                renderizarCitas(filtroEstado.value);
                
                if (nuevoEstado === 'anulada') {
                    alert('‚ö†Ô∏è Cita anulada');
                }
            }
        };

        // Funci√≥n para confirmar la eliminaci√≥n
        window.confirmarEliminar = function(id) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                idCitaEliminar = id;
                nombreMascotaEliminar.textContent = cita.nombreMascota;
                modalConfirmacion.classList.add('active');
            }
        };

        // Funci√≥n para eliminar una cita
        function eliminarCita() {
            const index = citas.findIndex(c => c.id === idCitaEliminar);
            if (index !== -1) {
                citas.splice(index, 1);
                guardarCitas();
                renderizarCitas(filtroEstado.value);
                modalConfirmacion.classList.remove('active');
                alert('üóëÔ∏è Cita eliminada correctamente');
                idCitaEliminar = null;
            }
        }

        // Event listener para confirmar eliminaci√≥n
        btnConfirmarEliminar.addEventListener('click', eliminarCita);

        // Event listener para cancelar eliminaci√≥n
        btnCancelarEliminar.addEventListener('click', function() {
            modalConfirmacion.classList.remove('active');
            idCitaEliminar = null;
        });

        // Cerrar modal de confirmaci√≥n al hacer clic fuera
        modalConfirmacion.addEventListener('click', function(e) {
            if (e.target === modalConfirmacion) {
                modalConfirmacion.classList.remove('active');
                idCitaEliminar = null;
            }
        });

        // Event listener para el filtro desplegable
        filtroEstado.addEventListener('change', function() {
            renderizarCitas(this.value);
        });

        // Abrir modal al hacer clic en "Agendar Cita"
        btnAgendar.addEventListener('click', function() {
            editando = false;
            idCitaEditando = null;
            modalTitulo.textContent = 'Guardar nueva cita';
            modalHeader.classList.remove('editar');
            btnGuardar.textContent = 'GUARDAR';
            btnGuardar.classList.remove('editar');
            modal.classList.add('active');
            formCita.reset();
        });

        // Cerrar modal con la X
        btnCerrarModal.addEventListener('click', function() {
            modal.classList.remove('active');
            editando = false;
            idCitaEditando = null;
        });

        // Cerrar modal con el bot√≥n "CERRAR"
        btnCancelar.addEventListener('click', function() {
            modal.classList.remove('active');
            editando = false;
            idCitaEditando = null;
        });

        // Cerrar modal al hacer clic fuera de √©l
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
                editando = false;
                idCitaEditando = null;
            }
        });

        // Funci√≥n para validar que la hora est√© entre 8 AM y 8 PM
        function validarHorario(hora) {
            if (!hora) return false;
            
            const [horas, minutos] = hora.split(':').map(Number);
            
            if (horas < 8 || horas > 20) {
                return false;
            }
            
            if (horas === 20 && minutos > 0) {
                return false;
            }
            
            return true;
        }

        // Validar el formulario al enviarlo
        formCita.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validar nombre de mascota
            if (nombreMascota.value.trim() === '') {
                alert('‚ö†Ô∏è Debes rellenar el campo "Nombre Mascota"');
                nombreMascota.focus();
                return;
            }

            // Validar propietario
            if (propietario.value.trim() === '') {
                alert('‚ö†Ô∏è Debes rellenar el campo "Propietario"');
                propietario.focus();
                return;
            }

            // Validar tel√©fono
            if (telefono.value.trim() === '') {
                alert('‚ö†Ô∏è Debes rellenar el campo "Tel√©fono"');
                telefono.focus();
                return;
            }

            // Validar fecha
            if (fechaCita.value === '') {
                alert('‚ö†Ô∏è Debes seleccionar una "Fecha de cita"');
                fechaCita.focus();
                return;
            }

            // Validar que la fecha sea futura
            const fechaSeleccionada = new Date(fechaCita.value);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            if (fechaSeleccionada <= hoy) {
                alert('‚ö†Ô∏è La fecha de la cita debe ser posterior a hoy (a partir de ma√±ana)');
                fechaCita.focus();
                return;
            }

            // Validar hora
            if (horaCita.value === '') {
                alert('‚ö†Ô∏è Debes seleccionar una "Hora de cita"');
                horaCita.focus();
                return;
            }

            // Validar que la hora est√© entre 8 AM y 8 PM
            if (!validarHorario(horaCita.value)) {
                alert('‚ö†Ô∏è La hora de la cita debe estar entre las 8:00 AM y las 8:00 PM');
                horaCita.focus();
                return;
            }

            // Validar tipo de mascota
            if (tipoMascota.value === '') {
                alert('‚ö†Ô∏è Debes seleccionar un "Tipo de mascota"');
                tipoMascota.focus();
                return;
            }

            // Validar s√≠ntomas
            if (sintomas.value.trim() === '') {
                alert('‚ö†Ô∏è Debes rellenar el campo "S√≠ntomas"');
                sintomas.focus();
                return;
            }

            // Si estamos editando
            if (editando && idCitaEditando !== null) {
                const cita = citas.find(c => c.id === idCitaEditando);
                if (cita) {
                    cita.nombreMascota = nombreMascota.value.trim();
                    cita.propietario = propietario.value.trim();
                    cita.telefono = telefono.value.trim();
                    cita.fechaCita = fechaCita.value;
                    cita.horaCita = horaCita.value;
                    cita.tipoMascota = tipoMascota.value;
                    cita.sintomas = sintomas.value.trim();

                    guardarCitas();
                    alert('‚úÖ Cita actualizada exitosamente');
                    
                    modal.classList.remove('active');
                    formCita.reset();
                    editando = false;
                    idCitaEditando = null;
                    renderizarCitas(filtroEstado.value);
                }
            } else {
                // Crear nueva cita
                const nuevaCita = {
                    id: Date.now(),
                    nombreMascota: nombreMascota.value.trim(),
                    propietario: propietario.value.trim(),
                    telefono: telefono.value.trim(),
                    fechaCita: fechaCita.value,
                    horaCita: horaCita.value,
                    tipoMascota: tipoMascota.value,
                    sintomas: sintomas.value.trim(),
                    estado: 'abierta',
                    factura: null
                };

                citas.push(nuevaCita);
                guardarCitas();
                alert('‚úÖ Cita guardada exitosamente');
                
                modal.classList.remove('active');
                formCita.reset();
                renderizarCitas(filtroEstado.value);
            }
        });

        // Inicializar mostrando las citas guardadas
        renderizarCitas();

        console.log('‚úÖ Administrador de Citas con Facturaci√≥n cargado correctamente');
    </script>
</body>
</html>